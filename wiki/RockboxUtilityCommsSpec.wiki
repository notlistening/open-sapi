#summary The Communication Protocol for Rockbox Utility Open Sapi Server
#labels Phase-Implementation
<wiki:toc max_depth="2" />
----
=Communication Specifications=

==Server Notes==

The server expects data to arrive in UTF-8 format from the client.

The client must call a single readyServer command before issuing any further commands to the server. If the server is running and responding then a 204:Ready response is received by the client. When the client receives this it can continue to send commands. 

The client currently checks to see if it can open the port to the server. If this fails it then begins to try and find the server executable and run the server. Once the server command has been executed it then tries to resend the serverReady command six times over a period of 60 seconds. This is mainly due to the fact that some machines are slow to start the server especially Linux as they are executing wine as well. 

All "settings" can be send in a group to the server or seperatly

The speakMe command must be sent on its own as the last command to start synthesis on the server using the current settings
----
=Server Client Communication Protocol=
General Code Rule:
200 = OK
400 = Error
500 = Erros

Command   : readyServer <br>
Arguments : None <br>
Returns   : Status No:Desc - (204:Ready) <br>
COmment   : This command must be send on its own as the other commands will be ignored.<br>

Command   : killServer <br>
Arguments : None <br>
Returns   : Status No:Desc - (299:Shutdown OK) <br>

Command   : closeClient <br>
Arguments : None <br>
Returns   : Status No:Desc - (294:Close Client) <br>
Comment   : This command must be sent when the client has finished sending commands to the server.<br>

--Settings--
Command   : getFormat <br>
Arguments : None <br>
Returns   : Status No:Desc:ID:Format - (298:Format List:1:SPSF_8kHz8BitMono) <br>

Command   : setFormat <br>
Arguments : Format ID <br>
Returns   : None <br>

Command   : outFile <br>
Arguments : Filename (/tmp/filename , c:\temp\filename) <br>
Returns   : None <br>
Comment   : This is the full filename including PATH. If this is missed off a file called sapi.wav is created in the PWD <br>

Command   : getVol <br>
Arguments : None <br>
Returns   : Status No:Desc:Volume - (295:Volume:100) <br>

Command   : setVol <br>
Arguments : Volume (0 - 100) <br>
Returns   : None <br>

Command   : setPitch <br>
Arguments : Pitch (-10 - +10) <br>
Returns   : None <br>

Command   : getEngine <br>
Arguments : None <br>
Returns   : Status No:Desc:ID:Name:Gender:Language:Vendor:Age - (297:Voice List:1:Microsoft Mary:Female:English_United_States,Microsoft,Adult) <br>

Command   : setEngine <br>
Arguments : ID <br>
Returns   : None <br>

Command   : getRate <br>
Arguments : None <br>
Returns   : Status No:Desc:Rate - (296:Rate:0)<br>

Command   : setRate <br>
Arguments : Rate (-10 - 10)<br>
Returns   : None <br>

Command   : speakMe <br>
Arguments : Text For Synth <br>
Returns   : Status : Desc (205:Synthesis OK) <br>
Comment   : This command should be sent on its own after all settings commands.<br>

Command   : speechFlag <br>
Arguments : Value (See extended notes at bottom) <br>
Returns   : None <br>
Comment   : This commands is optional and should not be used in normal operation.<br>

Command   : setDebug <br>
Arguments : None <br>
Returns   : None <br>
Comment   : This gives full output to stdout from the server for debugging <br>
----
=Table of Server Return Codes & Messages=
||*CODE*||*Message*||*Description*||
|| 200 || OK || General OK (unimplemented)||
|| 201 || Synth OK || Lets the client know that the synthesis is going ahead OK ||
|| 202 || Setting OK || Returned after any setting change on the server Rate Volume Speed Output file||
|| 203 || Test OK || If the test complete this code is returned (unimplemented)||
|| 204 || Server Ready || Signifies the server is ready for work||
|| 293 || End of List || This follows any list of data returned by the server||
|| 294 || Close Client || The server has finished its current job||
|| 295 || Volume || Returns the current server volume as well ||
|| 296 || Rate - Returns the current server rate ||
|| 297 || Voice List || Returns with a list of voices and their details ||
|| 298 || Format List || Returns with a list of supported wav formats ||
|| 299 || Shutdown OK || Acknowledges the shutdown request from the client ||   
|| 400 || Bad Request || Unimplemented||
|| 500 || Server Internal Error || Unimplemented ||    
|| 501 || Not Implemented || Unimplemented (how ironic)||
|| 504 || Time Out || Tells the client the server timed out while sitting idle ||
|| 513 ||Message Too Large || Unimplemented ||
|| 590 || COM Error || Give meaningful information about COM errors||
|| 591 || Core Component Missing || Gives information about the components ||    
|| 592 || Unexpected SAPI Error || Gives errors from SAPI ||    
|| 593 || Unsupported Wav Format || Somehow you have tried to you an unsupported format for your system||
|| 594 || No Speech Engines Match That Request || You have asked for a speech engine that does not exist on this system ||   
|| 595 || Shutdown Failure || something in the shut-down process failed ||   
|| 596 || Startup Failure  || Can't Start the server and the reason ||
|| 597 || Server Port Busy ||        
|| 598 || MS Visual C++ DLL Load Failure||        
|| 599 || Unable to Initialise SAPI||

----
=Extended Notes=

==Speech Flags==
The client should not set the speech flag only in very special cases the server does not expect the speech flag to be set.
See the SAPI documentation for further details. <br>
SVSFDefault = 0 <br>
SVSFlagsAsync = 1 <br>
SVSFPurgeBeforeSpeak = 2 <br>
SVSFIsFilename = 4 <br>
SVSFIsXML = 8 <br>
SVSFIsNotXML = 16 <br>
SVSFPersistXML = 32 <br>
SVSFNLPSpeakPunc = 64 <br>
----
==Wav format list==
The server test each individual format on the OS it is running as not all formats are supported and returns a list of formats that it can use. This list is just for reference.
0    SPSF_NoAssignedFormat <br>
1    SPSF_Text <br>
3    SPSF_NonStandardFormat <br>
4    SPSF_ExtendedAudioFormat  <br>
5    SPSF_8kHz8BitMono <br>
6    SPSF_8kHz8BitStereo <br>
7    SPSF_8kHz16BitMono <br>
8    SPSF_8kHz16BitStereo <br>
9    SPSF_11kHz8BitMono <br>
10   SPSF_11kHz8BitStereo <br>
11   SPSF_11kHz16BitMono <br>
12   SPSF_11kHz16BitStereo <br>
13   SPSF_12kHz8BitMono <br>
14   SPSF_12kHz8BitStereo <br>
16   SPSF_12kHz16BitMono <br>
17   SPSF_12kHz16BitStereo <br>
18   SPSF_16kHz8BitMono <br>
19   SPSF_16kHz8BitStereo <br>
20   SPSF_16kHz16BitMono <br>
21   SPSF_16kHz16BitStereo <br>
22   SPSF_22kHz8BitMono <br>
25   SPSF_22kHz8BitStereo <br>
26   SPSF_22kHz16BitMono <br>
27   SPSF_22kHz16BitStereo <br>
28   SPSF_24kHz8BitMono <br>
29   SPSF_24kHz8BitStereo<br>
30   SPSF_24kHz16BitMono <br>
31   SPSF_24kHz16BitStereo <br>
32   SPSF_32kHz8BitMono <br>
33   SPSF_32kHz8BitStereo <br>
35   SPSF_32kHz16BitMono <br>
36   SPSF_32kHz16BitStereo <br>
37   SPSF_44kHz8BitMono <br>
38   SPSF_44kHz8BitStereo <br>
39   SPSF_44kHz16BitMono <br>
40   SPSF_44kHz16BitStereo <br>
41   SPSF_48kHz8BitMono <br>
42   SPSF_48kHz8BitStereo <br>
43   SPSF_48kHz16BitMono <br>
44   SPSF_48kHz16BitStereo <br>
45   SPSF_TrueSpeech_8kHz1BitMono <br>
46   SPSF_CCITT_ALaw_8kHzMono <br>
47   SPSF_CCITT_ALaw_8kHzStereo <br>
48   SPSF_CCITT_ALaw_11kHzMono <br>
49   SPSF_CCITT_ALaw_11kHzStereo <br>
50   SPSF_CCITT_ALaw_22kHzMono <br>
51   SPSF_CCITT_ALaw_22kHzStereo <br>
52   SPSF_CCITT_ALaw_44kHzMono <br>
53   SPSF_CCITT_ALaw_44kHzStereo <br>
54   SPSF_CCITT_uLaw_8kHzMono <br>
55   SPSF_CCITT_uLaw_8kHzStereo <br>
56   SPSF_CCITT_uLaw_11kHzMono <br>
57   SPSF_CCITT_uLaw_11kHzStereo <br>
58   SPSF_CCITT_uLaw_22kHzMono <br>
59   SPSF_CCITT_uLaw_22kHzStereo <br>
60   SPSF_CCITT_uLaw_44kHzMono <br>
61   SPSF_CCITT_uLaw_44kHzStereo <br>
62   SPSF_ADPCM_8kHzMono <br>
63   SPSF_ADPCM_8kHzStereo <br>
64   SPSF_ADPCM_11kHzMono <br>
65   SPSF_ADPCM_11kHzStereo <br>
66   SPSF_ADPCM_22kHzMono <br>
67   SPSF_ADPCM_22kHzStereo <br>
68   SPSF_ADPCM_44kHzMono <br>
69   SPSF_ADPCM_44kHzStereo <br>
70   SPSF_GSM610_8kHzMono <br>
71   SPSF_GSM610_11kHzMono <br>
72   SPSF_GSM610_22kHzMono <br>
73   SPSF_GSM610_44kHzMono <br>